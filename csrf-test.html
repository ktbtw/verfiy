<!DOCTYPE html>
<html>
<head>
  <title>CSRF Token 测试</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    pre { background: #f5f5f5; padding: 10px; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>CSRF Token 诊断工具</h1>
  
  <h2>1. 检查当前 Cookies</h2>
  <button onclick="checkCookies()">检查 Cookies</button>
  <pre id="cookies"></pre>
  
  <h2>2. 测试登录</h2>
  <input type="text" id="username" placeholder="用户名" value="admin">
  <input type="password" id="password" placeholder="密码" value="admin123">
  <button onclick="testLogin()">登录</button>
  <pre id="loginResult"></pre>
  
  <h2>3. 获取 CSRF Token</h2>
  <button onclick="getCSRFToken()">获取 Token</button>
  <pre id="tokenResult"></pre>
  
  <h2>4. 测试带 Token 的 POST 请求</h2>
  <button onclick="testPost()">测试 POST</button>
  <pre id="postResult"></pre>

  <script>
    function checkCookies() {
      const cookies = document.cookie;
      const csrfToken = getCookie('XSRF-TOKEN');
      document.getElementById('cookies').textContent = 
        'All cookies:\n' + cookies + '\n\n' +
        'XSRF-TOKEN: ' + (csrfToken || '未找到');
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    async function testLogin() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      try {
        const resp = await fetch('/verfiy/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ username, password })
        });
        const data = await resp.json();
        document.getElementById('loginResult').textContent = 
          'Status: ' + resp.status + '\n' +
          'Response: ' + JSON.stringify(data, null, 2);
      } catch (e) {
        document.getElementById('loginResult').textContent = 'Error: ' + e.message;
      }
    }

    async function getCSRFToken() {
      try {
        const resp = await fetch('/verfiy/admin/apps/api/my-apps', {
          credentials: 'include'
        });
        
        document.getElementById('tokenResult').textContent = 
          'Status: ' + resp.status + '\n' +
          'Response Headers:\n' + 
          Array.from(resp.headers.entries()).map(([k, v]) => `${k}: ${v}`).join('\n') + '\n\n' +
          'Cookie after request:\n' + document.cookie + '\n\n' +
          'XSRF-TOKEN: ' + (getCookie('XSRF-TOKEN') || '未找到');
      } catch (e) {
        document.getElementById('tokenResult').textContent = 'Error: ' + e.message;
      }
    }

    async function testPost() {
      const csrfToken = getCookie('XSRF-TOKEN');
      
      try {
        const resp = await fetch('/verfiy/admin/apps/select?appId=1', {
          method: 'POST',
          credentials: 'include',
          headers: {
            'X-XSRF-TOKEN': csrfToken || ''
          }
        });
        
        document.getElementById('postResult').textContent = 
          'CSRF Token used: ' + (csrfToken || '无') + '\n' +
          'Status: ' + resp.status + '\n' +
          'Status Text: ' + resp.statusText;
      } catch (e) {
        document.getElementById('postResult').textContent = 'Error: ' + e.message;
      }
    }

    // 自动检查
    window.onload = checkCookies;
  </script>
</body>
</html>

